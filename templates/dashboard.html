<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Личный кабинет • BonusDostavka</title>
    <style>
        body {font-family: Arial, sans-serif; margin:40px; background:#f8f9fa; color:#333; line-height:1.6;}
        h1, h2, h3 {color:#222;}
        .btn {padding:12px 24px; background:#007bff; color:white; text-decoration:none; border-radius:50px; font-weight:bold;}
        .bot {background:white; padding:30px; margin:30px 0; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.1);}
        button {padding:12px 28px; border:none; border-radius:50px; cursor:pointer; font-weight:bold;}
        .green-btn {background:#28a745;}
        .red-btn {background:#dc3545;}
        .orange-btn {background:#ff9800;}
        summary {cursor:pointer; font-weight:bold; font-size:18px;}
        details {margin:15px 0;}
        hr {border:none; height:1px; background:#ddd; margin:30px 0;}
    </style>
</head>
<body>

<!-- ШАПКА С КНОПКОЙ КОРЗИНЫ -->
<h1>Привет, {{ user }}!</h1>
<a href="/create" class="btn">Создать нового бота</a>
<a href="/logout" class="btn" style="background:#6c757d; margin-left:10px;">Выйти</a>
<a href="/cart" style="float:right; background:#ff9800; color:white; padding:14px 36px; border-radius:50px; text-decoration:none; font-weight:bold; font-size:18px; box-shadow:0 4px 15px rgba(255,152,0,0.3);">
  Корзина
</a>
<div style="clear:both;"></div>
<br>

<!-- Уведомления -->
{% if request.query_params.msg %}
<div style="background:#d4edda; color:#155724; padding:15px; border-radius:12px; margin:20px 0; font-weight:bold; border-left:5px solid #28a745;">
  {{ request.query_params.msg }}
</div>
{% endif %}

<!-- Если ботов нет -->
{% if not bots %}
  <div style="text-align:center; margin:100px 0; padding:60px; background:white; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.1);">
    <h2>У тебя пока нет ботов</h2>
    <p style="font-size:18px; color:#555;">Создай своего первого бота и начни зарабатывать уже сегодня!</p>
    <a href="/create" class="btn" style="font-size:20px; padding:18px 50px; margin-top:20px; display:inline-block;">Создать бота</a>
  </div>
{% else %}

  <!-- Цикл по всем ботам -->
  {% for bot in bots %}
    <div class="bot">
      <h2>@{{ bot[1] }} <small style="color:#777;">(ID: {{ bot[0] }})</small></h2>
      <a href="https://t.me/{{ bot[1] }}" target="_blank" class="btn">Открыть бота в Telegram</a>

      <!-- Категории с фото -->
      <hr>
      <p><b>Категории:</b></p>
      {% if categories.get(bot[0], []) %}
        {% for cat in categories.get(bot[0], []) %}
          <div style="background:#f8f9fa; padding:15px; margin:15px 0; border-radius:16px; border:1px solid #eee; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
            <strong style="font-size:18px;">{{ cat[2] }}</strong> (ID: {{ cat[0] }})
            
            <!-- Фото категории -->
            {% if cat[3] %}
              <div style="margin:10px 0;">
                <img src="/{{ cat[3] }}" style="max-height:200px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
              </div>
            {% else %}
              <div style="margin:10px 0; color:#999; font-style:italic;">(фото не загружено)</div>
            {% endif %}
            
            <!-- Форма загрузки фото -->
            <form action="/upload_category_photo" method="post" enctype="multipart/form-data" style="margin:10px 0;">
              <input type="hidden" name="cat_id" value="{{ cat[0] }}">
              <input type="hidden" name="bot_id" value="{{ bot[0] }}">
              <input type="file" name="photo" accept="image/*" style="padding:8px;">
              <button type="submit" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:8px; margin-left:10px;">Загрузить фото</button>
            </form>
            
            <!-- Кнопка удаления фото -->
            {% if cat[3] %}
              <form action="/delete_category_photo" method="post" style="display:inline;">
                <input type="hidden" name="cat_id" value="{{ cat[0] }}">
                <input type="hidden" name="bot_id" value="{{ bot[0] }}">
                <button type="submit" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:8px;">Удалить фото</button>
              </form>
            {% endif %}
            
            <!-- Кнопка удаления категории -->
            <form action="/delete_category" method="post" style="display:inline; margin-left:10px;">
              <input type="hidden" name="cat_id" value="{{ cat[0] }}">
              <input type="hidden" name="bot_id" value="{{ bot[0] }}">
              <button type="submit" style="padding:8px 16px; background:#c82333; color:white; border:none; border-radius:8px;">Удалить категорию</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <p><i>Категорий пока нет</i></p>
      {% endif %}

      <form action="/add_category" method="post" style="margin-top:15px;">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        <input type="text" name="name" placeholder="Новая категория (например: Супы)" required style="padding:12px; border-radius:12px; border:1px solid #ccc; width:300px;">
        <button type="submit" class="green-btn">+ Добавить категорию</button>
      </form>

      <!-- ТОВАРЫ -->
      <hr>
      <h3>Товары</h3>

      {% if categories.get(bot[0], []) %}
        {% for cat in categories.get(bot[0], []) %}
          <details open style="background:#f8f9fa; padding:15px; border-radius:16px; margin:15px 0;">
            <summary>
              {{ cat[2] }} ({{ products.get(cat[0], []) | length }} шт.)
            </summary>

              <!-- ТОВАРЫ В СПИСКЕ (КАРТОЧКИ ПОД ДРУГОМ) -->
              {% for prod in products.get(cat[0], []) %}
                <div style="background:white; padding:20px; margin:15px 0; border-radius:16px; border:1px solid #eee; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
                  <div style="display:flex; align-items:flex-start;">
                    {% if prod[6] %}
                      <img src="/{{ prod[6] }}" style="width:120px; height:120px; object-fit:cover; border-radius:16px; margin-right:25px; flex-shrink:0;">
                    {% else %}
                      <div style="width:120px; height:120px; background:#f0f0f0; border-radius:16px; margin-right:25px; display:flex; align-items:center; justify-content:center; color:#aaa; font-size:13px; text-align:center; flex-shrink:0;">
                        Нет фото
                      </div>
                    {% endif %}

                    <div style="flex:1;">
                      <h4 style="margin:0 0 8px 0; font-size:20px; color:#222;">{{ prod[3] }}</h4>
                      <p style="margin:0 0 12px 0; color:#555; font-size:15px;">{{ prod[5] or "Без описания" }}</p>
                      <span style="font-size:24px; color:#d32f2f; font-weight:bold;">{{ prod[4] }} ₽</span>
                    </div>

                    <!-- КНОПКИ СПРАВА -->
                    <div style="text-align:right; min-width:220px;">
                      <!-- Переключатель "В продаже" -->
                      <form action="/toggle_product" method="post" style="display:inline-block; margin-bottom:15px;">
                        <input type="hidden" name="prod_id" value="{{ prod[0] }}">
                        <label class="switch" style="display:inline-block; vertical-align:middle;">
                          <input type="checkbox" name="enabled" {% if prod[7] == 1 %}checked{% endif %} onchange="this.form.submit()">
                          <span class="slider round"></span>
                        </label>
                        <span style="margin-left:10px; font-size:15px; color:#555; vertical-align:middle;">
                          В продаже
                        </span>
                      </form>
                      <br><br>
                      <a href="/edit_product/{{ prod[0] }}" style="background:#007bff; color:white; padding:10px 20px; border-radius:50px; text-decoration:none; margin:5px 0; display:inline-block; font-size:15px;">
                        Редактировать
                      </a>
                      <br>
                      <form action="/delete_product" method="post" style="display:inline;">
                        <input type="hidden" name="prod_id" value="{{ prod[0] }}">
                        <button type="submit" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:50px; font-size:15px;">
                          Удалить
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}

            <!-- Добавление товара -->
            <div style="background:#fff; padding:20px; border-radius:16px; margin-top:20px; border:2px dashed #28a745;">
              <h4>Добавить товар в категорию «{{ cat[2] }}»</h4>
              <form action="/add_product" method="post" enctype="multipart/form-data">
                <input type="hidden" name="bot_id" value="{{ bot[0] }}">
                <input type="hidden" name="cat_id" value="{{ cat[0] }}">
                <input type="text" name="name" placeholder="Название товара" required style="width:100%; padding:12px; margin:8px 0; border-radius:12px; border:1px solid #ccc;">
                <input type="number" name="price" placeholder="Цена в рублях" required style="width:100%; padding:12px; margin:8px 0; border-radius:12px; border:1px solid #ccc;">
                <textarea name="description" placeholder="Описание (необязательно)" style="width:100%; padding:12px; margin:8px 0; border-radius:12px; border:1px solid #ccc;" rows="3"></textarea>
                <p><strong>Фото товара:</strong></p>
                <input type="file" name="photo" accept="image/*" style="margin:10px 0;">
                <br><br>
                <button type="submit" class="green-btn" style="padding:14px 32px; font-size:16px;">+ Добавить товар</button>
              </form>
            </div>
          </details>
        {% endfor %}

      {% else %}
        <p style="text-align:center; color:#777; font-style:italic; padding:40px; background:#f0f0f0; border-radius:16px;">
          Добавьте первую категорию — и начните наполнять магазин товарами!
        </p>
      {% endif %}

<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #333;">Способы получения заказа</h3>
    
    <form method="post" action="/toggle_order_type">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">

        <!-- В зале -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
            <label style="font-size: 16px; color: #444;">В зале</label>
            <label class="switch">
                <input type="checkbox" name="in_hall" {% if bot[4] == 1 %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>

        <!-- Самовывоз -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
            <label style="font-size: 16px; color: #444;">Самовывоз</label>
            <label class="switch">
                <input type="checkbox" name="takeaway" {% if bot[5] == 1 %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>

        <!-- Доставка курьером -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
            <label style="font-size: 16px; color: #444;">Доставка курьером</label>
            <label class="switch">
                <input type="checkbox" name="delivery" {% if bot[6] == 1 %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>

        <button type="submit" style="margin-top: 20px; padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            Сохранить настройки
        </button>
    </form>
</div>

<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #333;">Бонусная система</h3>
    <p style="color:#444;">Настраивайте, как начисляются и тратятся бонусы.</p>
   
    <form action="/save_bonus_settings" method="post">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">

        <label>
            <input type="checkbox" name="bonuses_enabled" {% if bot[14] == 1 %}checked{% endif %}>
            Бонусная система включена
        </label><br><br>

        <label>Процент начисления бонусов от суммы заказа (%):<br>
            <input type="number" name="bonus_percent" value="{{ bot[15] if bot[15] is not none else 10 }}" min="0" max="100" step="1" style="width:100px; padding:8px;">
        </label><br><br>

        <label>Максимальный процент оплаты бонусами (%):<br>
            <input type="number" name="max_bonus_pay_percent" value="{{ bot[16] if bot[16] is not none else 30 }}" min="0" max="100" step="1" style="width:100px; padding:8px;">
        </label><br><br>

        <label>Минимальная сумма заказа для начисления бонусов (₽):<br>
            <input type="number" name="min_order_for_bonus" value="{{ bot[17] if bot[17] is not none else 0 }}" min="0" step="1" style="width:150px; padding:8px;">
        </label><br><br>

        <label>Сгорание бонусов через N дней (0 = не сгорают):<br>
            <input type="number" name="bonus_expire_days" value="{{ bot[18] if bot[18] is not none else 0 }}" min="0" step="1" style="width:100px; padding:8px;">
        </label><br><br>

        <label>Приветственный бонус для новых клиентов (бонусов):<br>
            <input type="number" name="welcome_bonus" value="{{ bot[19] if bot[19] is not none else 0 }}" min="0" step="1" style="width:150px; padding:8px;">
        </label><br><br>

        <button type="submit" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            Сохранить настройки бонусов
        </button>
    </form>
</div>

<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #333;">Время работы кафе</h3>
   
    <form method="post" action="/save_work_time">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        
        <div style="margin: 15px 0;">
            <label style="font-size: 16px; color: #444;">Ограничивать заказы по времени</label>
            <label class="switch" style="float:right;">
                <input type="checkbox" name="restrict_orders" {% if bot[10] == 1 %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
            <div style="clear:both;"></div>
        </div>
        
        <div style="margin: 15px 0;">
            <label>Часовой пояс:</label>
            <select name="timezone" style="padding:8px; border-radius:8px; border:1px solid #ccc; width:200px;">
                <option value="Europe/Moscow" {% if bot[7] == "Europe/Moscow" %}selected{% endif %}>Москва (UTC+3)</option>
                <option value="Europe/Kaliningrad" {% if bot[7] == "Europe/Kaliningrad" %}selected{% endif %}>Калининград (UTC+2)</option>
                <option value="Europe/Samara" {% if bot[7] == "Europe/Samara" %}selected{% endif %}>Самара (UTC+4)</option>
                <option value="Asia/Yekaterinburg" {% if bot[7] == "Asia/Yekaterinburg" %}selected{% endif %}>Екатеринбург (UTC+5)</option>
                <option value="Asia/Novosibirsk" {% if bot[7] == "Asia/Novosibirsk" %}selected{% endif %}>Новосибирск (UTC+7)</option>
                <option value="Asia/Vladivostok" {% if bot[7] == "Asia/Vladivostok" %}selected{% endif %}>Владивосток (UTC+10)</option>
                <option value="Asia/Kamchatka" {% if bot[7] == "Asia/Kamchatka" %}selected{% endif %}>Камчатка (UTC+12)</option>
            </select>
        </div>
        
        <div style="margin: 15px 0;">
            <label>Работаем с:</label>
            <input type="time" name="work_start" value="{{ bot[8] or '' }}" style="padding:8px; border-radius:8px;">
            <label style="margin-left:20px;">по:</label>
            <input type="time" name="work_end" value="{{ bot[9] or '' }}" style="padding:8px; border-radius:8px;">
        </div>
        
        <button type="submit" style="margin-top: 20px; padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            Сохранить время работы
        </button>
    </form>
</div>

<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #333;">Автоотмена заказа</h3>
    <p style="color:#555;">Если сотрудник не принял и не отменил заказ — он автоматически отменится через указанное время.</p>
   
    <form method="post" action="/save_auto_cancel">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        
        <!-- ПЕРЕКЛЮЧАТЕЛЬ ВКЛ/ВЫКЛ -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin: 15px 0;">
            <label style="font-size: 16px; color: #444;">Автоотмена заказов</label>
            <label class="switch">
                <input type="checkbox" name="auto_cancel_enabled" {% if bot[12] == 1 %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        </div>
        
        <div style="margin: 15px 0;">
            <label>Автоотмена через:</label>
            <input type="number" name="minutes" value="{{ bot[11] or 60 }}" min="10" max="120" style="padding:8px; width:80px; border-radius:8px; border:1px solid #ccc;">
            <span style="margin-left:10px; color:#555;">минут (10-120)</span>
        </div>
        
        <button type="submit" style="padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            Сохранить автоотмену
        </button>
    </form>
</div>
<!-- СТИЛИ ДЛЯ КРАСИВЫХ ПЕРЕКЛЮЧАТЕЛЕЙ -->
<style>
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #28a745;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
</style>

      <hr>
      <p><b>Текст кнопки «О нас»:</b></p>
      <form action="/update_about" method="post">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        <textarea name="about" style="width:100%; padding:12px; border-radius:12px;" rows="4">{{ bot[2] }}</textarea><br><br>
        <button type="submit" class="green-btn">Сохранить</button>
      </form>
<div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="margin-top: 0; color: #333;">Фото меню (несколько страниц)</h3>
    <p style="color:#555;">Загрузите страницы меню. Они будут показываться по порядку при нажатии кнопки "Меню" в боте.</p>
    
    <form method="post" action="/upload_menu_photos" enctype="multipart/form-data">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        
        <label style="display:block; margin-bottom:8px;">Загрузите несколько фото (можно зажать Ctrl/Cmd):</label>
        <input type="file" name="photos" accept="image/*" multiple style="margin-bottom:15px;">
        
        <button type="submit" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:8px;">Загрузить фото</button>
    </form>
    
    <!-- Показ существующих фото -->
    {% set menu_photos = get_menu_photos(bot[0]) %}
    {% if menu_photos %}
        <h4 style="margin-top:20px;">Загруженные страницы меню:</h4>
        {% for photo in menu_photos %}
            <div style="display:inline-block; margin:10px; text-align:center;">
                <img src="/{{ photo.photo_path }}" style="max-width:200px; border-radius:8px;">
                <br>
                <form method="post" action="/delete_menu_photo" style="display:inline;">
                    <input type="hidden" name="photo_id" value="{{ photo.id }}">
                    <input type="hidden" name="bot_id" value="{{ bot[0] }}">
                    <button type="submit" style="margin-top:5px; padding:5px 10px; background:#dc3545; color:white; border:none; border-radius:4px; font-size:12px;">Удалить</button>
                </form>
            </div>
        {% endfor %}
    {% endif %}
</div>
<form method="post" action="/save_notify_chat">
    <input type="hidden" name="bot_id" value="{{ bot[0] }}">
    <p>
        <strong>ID чата для уведомлений о заказах:</strong><br>
        <input type="text" name="notify_chat_id" value="{{ bot.notify_chat_id or '' }}" 
               placeholder="-1001234567890" style="width: 300px; padding: 8px;">
        <br><small>Добавьте бота в чат кафе → перешлите id чата сюда</small>
    </p>
    <button type="submit">Сохранить чат уведомлений</button>
</form>
<br>
      <hr>
      <p><b>Рассылка всем клиентам:</b></p>
      <form action="/send_broadcast" method="post" enctype="multipart/form-data">
        <input type="hidden" name="bot_id" value="{{ bot[0] }}">
        <textarea name="message" placeholder="Текст сообщения всем клиентам..." rows="4" style="width:100%; padding:12px; border-radius:12px;"></textarea><br>
        <input type="file" name="photo" accept="image/*"><br><br>
        <button type="submit" class="red-btn">Отправить всем</button>
      </form>

      <hr>
      <div style="text-align:center; padding:20px; background:#ffebee; border-radius:16px; border:2px solid #ffcdd2;">
        {% if request.query_params.confirm_delete and request.query_params.bot == bot[0]|string %}
          <p style="color:#c62828; font-weight:bold; font-size:18px;">
            Удалить бота @{{ bot[1] }} навсегда?
          </p>
          <form action="/confirm_delete_bot" method="post" style="display:inline; margin:0 10px;">
            <input type="hidden" name="bot_id" value="{{ bot[0] }}">
            <button type="submit" style="background:#c62828; padding:12px 32px;">Да, удалить навсегда</button>
          </form>
          <a href="/dashboard" style="background:#757575; color:white; padding:12px 32px; border-radius:50px; text-decoration:none;">Отмена</a>
        {% else %}
          <form action="/delete_bot" method="post" style="display:inline;">
            <input type="hidden" name="bot_id" value="{{ bot[0] }}">
            <button type="submit" style="background:#ef5350; color:white; padding:12px 32px; font-weight:bold;">
              Удалить этого бота
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% endif %}

</body>
</html>